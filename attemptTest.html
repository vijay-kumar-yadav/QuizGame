<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quiz</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
    />
    <link rel="stylesheet" href="./css/alertStyle.css" />
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css"
      integrity="sha512-xh6O/CkQoPOWDdYTDqeRdPCVd1SpvCA9XXcUnZS2FmJNp1coAFzvtCN9BmamE+4aHK8yyUHUSCcJHgXloTyT2A=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <script src="./js/confirmationWindow.js"></script>
    <link rel="stylesheet" href="./css/attemptTest.css" />
  </head>
  <body>
    <!-- Confirmation Modal -->
    <div
      class="modal fade"
      id="confimartionModal"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
      aria-labelledby="confimartionModalLabel"
      aria-hidden="false"
    >
      <div class="modal-dialog rounded-0">
        <div class="modal-content rounded-0">
          <div class="modal-header py-1">
            <h5 class="modal-title" id="confimartionModalLabel"></h5>
          </div>
          <div class="modal-body rounded-0"></div>
          <div class="modal-footer py-1 rounded-0">
            <button
              type="button"
              class="btn btn-primary btn-sm rounded-0 confirm-btn"
            >
              Continue
            </button>
            <button
              type="button"
              class="btn btn-secondary btn-sm rounded-0 closed-btn"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- confirmational model end -->
    <div class="outer">
      <div class="alert" role="alert"></div>
      <div class="middle head">
        <div class="container inner">
          <div id="quiz"></div>
        </div>
        <div class="d-flex justify-content-center quitSubmit">
          <button class="mr-5 btn btnQuiz bg-danger" onclick="onExitClick()">
            Quit
          </button>
          <button class="btn btnQuiz bg-success" onclick="onNextClick()">
            Next
          </button>
          <button class="ml-5 btn btnQuiz bg-primary" onclick="onSubmitClick()">
            Submit
          </button>
        </div>
      </div>
    </div>
    <script>
      $(document).ready(() => {
        if (!JSON.parse(sessionStorage.getItem("TestStart"))) {
          $("body").css("filter", "blur(3px)");
          setTimeout(() => {
            alert("Invalid Entry");
            location.href = "./index.html";
          }, 1000);
        } else {
          sessionStorage.setItem("showResult", true);
        }
      });

      var result = {};
      var amount = "10";
      var difficulty = "easy";
      var testType = sessionStorage.getItem("TestType");
      // https://opentdb.com/api.php?amount=10&category=24&difficulty=medium&type=multiple
      let mcq =
        "https://opentdb.com/api.php?amount=" +
        amount +
        "&category=" +
        testType +
        "&difficulty=" +
        difficulty +
        "&type=multiple";
      // console.log(mcq);
      function quesSkeleton(questionNo, question, options) {
        // opt=option
        var tDivParent = $("<div></div>").attr("class", "timerDivParent");
        var tDiv = $("<div></div>").attr("id", "timerDiv");
        var tP = $("<h2></h2>").attr("id", "timer").addClass("text-center");
        tDiv.append(tP);
        tDivParent.append(tDiv);
        var bDiv = $("<div></div")
          .addClass("border")
          .attr("id", "border" + questionNo);

        var quizDiv = $("<div></div>").attr(
          "class",
          " bg-white p-3 border-bottom "
        );
        var quizNameDiv = $("<div></div>").attr(
          "class",
          "d-flex flex-row justify-content-between align-items-center"
        );
        var nameOfQuiz = sessionStorage.getItem("QuizName");
        var quizNameH = $("<h4></h4>").text(nameOfQuiz + " Quiz");
        var quizNumberSpan = $("<span></span>").text(
          questionNo + 1 + " of " + totalQues
        );
        quizNameDiv.append(quizNameH, quizNumberSpan);
        quizDiv.append(quizNameDiv);
        var qaDiv = $("<div></div>")
          .attr("id", "quesAnsDiv" + questionNo)
          .addClass("bg-white p-3 border-bottom");
        var qDiv = $("<div></div>")
          .attr("id", "quesDiv")
          .addClass("d-flex flex-row align-items-center question-title");
        var quesSymbol = $("<h3></h3>").addClass("text-danger").text("Q.");
        var quesH = $("<H5></H5>")
          .attr("id", "ques" + questionNo)
          .addClass("mt-1 ml-2")
          .text(question);
        qDiv.append(quesSymbol, quesH);
        var aDiv = $("<div></div>").attr("id", "ansDiv").addClass("ans ml-2");
        for (let k = 0; k < options.length; k++) {
          var lb = $("<label></label>").addClass("radio");
          var aI = $("<input/>")
            .attr("name", questionNo)
            .attr("type", "radio")
            .attr("value", k);

          aI.change((event) => {
            result[questionNo] = event.target.value;
          });
          var optionSpan = $("<span></span>").text(options[k]);
          lb.append(aI, optionSpan);
          aDiv.append(lb);
        }
        qaDiv.append(qDiv, aDiv);
        bDiv.append(quizDiv, qaDiv);
        $("#quiz").append(tDivParent, bDiv);
        // var nextButton = "";
        // if (questionNo != totalQues - 1) {
        //   nextButton = $("<button></button>")
        //     .attr("id", "next" + questionNo)
        //     .text("Next");
        // }
        //qP = ques para
        //aI = answer Input
        //lb = label
        //tP = timerPara
        //qaDiv = questionAnswerDiv
        //qDiv = questionDiv
        //aDiv = answerDiv
      }
      //slideshow
      var intr;
      var totalQues;
      var timeBTWques = 30;
      var perQuesTime = timeBTWques * 1000;
      var totalTime;
      var count = timeBTWques;
      var quesNumber = 0;
      var ques = 0;
      function displayTimer() {}
      function start(ques) {
        // console.log(ques);
        quesSkeleton(
          quesNumber,
          ques[quesNumber].question,
          ques[quesNumber].answers
        );
        // nextButton.click(() => {
        //     $("#quesAnsDiv" + quesNumber).remove();
        //   });
        intr = setInterval(() => startSlideshow(ques), 1000);
      }
      function alertMessage(msg, msgTime) {
        $(".alert").addClass("show").text(msg);
        $(".alert").removeClass("hide");
        $(".alert").addClass("showAlert");
        setTimeout(function () {
          $(".alert").removeClass("show");
          $(".alert").addClass("hide");
        }, msgTime);
      }
      function calculateResult(resultArr, correctAnswers) {
        let marks = totalQues;
        sessionStorage.setItem("answerAttempted", resultArr);

        resultArr.map((e, index) => {
          if (e != correctAnswers[index]) {
            --marks;
          }
        });
        // console.log("marks", marks);
        return marks;
      }
      function checkAnswerAttemptedAlert(quesNo) {
        if (result[quesNo - 1] != 4) {
          $(".alert").removeClass("alert-info");
          $(".alert").addClass("alert-success");
          alertMessage("Your Answer Saved!", 1000);
        } else {
          $(".alert").removeClass("alert-success");
          $(".alert").addClass("alert-info");
          alertMessage("Answer Saved Automatically!", 1000);
        }
      }
      function submitQuizResult() {
        // console.log("your result", result);
        $(".quitSubmit").remove();
        let resultArr = [];
        for (let key in result) resultArr.push(result[key]);
        var correctAnswers = [];
        for (let i = 0; i < totalQues; i++) {
          correctAnswers.push(ques[i].correctIndex);
        }

        sessionStorage.setItem(
          "YourScore",
          calculateResult(resultArr, correctAnswers)
        );
        // console.log(typeof sessionStorage.getItem("answers"));

        clearInterval(intr);
        sessionStorage.setItem("TestStart", false);
        $("#quiz").hide();
        $(".alert").addClass("alert-primary");

        alertMessage("Calculating your result wait", 2800);
        setTimeout(() => {
          location.href = "./resultTest.html";
        }, 3000);
      }
      function startSlideshow(ques) {
        if (count == 0) {
          count = timeBTWques;
          $("#border" + quesNumber).remove();
          // console.log(quesNumber);
          quesNumber++;
          if (quesNumber < totalQues) {
            quesSkeleton(
              quesNumber,
              ques[quesNumber].question,
              ques[quesNumber].answers
            );
          }
          checkAnswerAttemptedAlert(quesNumber);
          if (quesNumber == totalQues) {
            submitQuizResult();
          }
        }
        $("#timer").text(count);
        count--;
      }
      //on next click
      function onNextClick() {
        if (quesNumber >= totalQues) return;
        console.log("clicked" + " " + quesNumber + " " + totalQues);
        count = timeBTWques;
        $("#border" + quesNumber).remove();

        quesNumber++;
        if (quesNumber < totalQues) {
          quesSkeleton(
            quesNumber,
            ques[quesNumber].question,
            ques[quesNumber].answers
          );
        }
        checkAnswerAttemptedAlert(quesNumber);
        if (quesNumber == totalQues) submitQuizResult();

        // console.log(quesNumber);
      }

      //convert online api response to my api response
      function shuffleOptions(array) {
        let currentIndex = array.length,
          randomIndex;

        // While there remain elements to shuffle.
        while (currentIndex != 0) {
          // Pick a remaining element.
          randomIndex = Math.floor(Math.random() * currentIndex);
          currentIndex--;

          // And swap it with the current element.
          [array[currentIndex], array[randomIndex]] = [
            array[randomIndex].replace("&#039;", "'").replace("&#039;s", "'"),
            array[currentIndex]
              .replace("&#039;", "'")
              .replace("&#039;", "'")
              .replace("&#039;s", "'")
              .replace("&#039;s", "'")
              .replace("&AMP;", "&")
              .replace("&AMP;", "&")
              .replace("&amp;", "&")
              .replace("&amp;", "&")
              .replace("&quot;", '"')
              .replace("&quot;", '"'),
          ];
        }

        return array;
      }

      function convertApi(responseObject) {
        var myResponse = {
          questions: [],
        };
        for (let res of responseObject.results) {
          // console.log(res);
          var options = shuffleOptions([
            res.correct_answer,
            ...res.incorrect_answers,
          ]);
          myResponse.questions.push({
            question: res.question
              .replace("&quot;", '"')
              .replace("&quot;", '"')
              .replace("&#039;", "'")
              .replace("&#039;", "'")
              .replace("&#039;s", "'")
              .replace("&#039;s", "'")
              .replace("&AMP;", "&")
              .replace("&AMP;", "&")
              .replace("&amp;", "&")
              .replace("&amp;", "&"),
            answers: options,
            correctIndex: options.indexOf(res.correct_answer),
          });
        }
        sessionStorage.setItem("mcq", JSON.stringify(myResponse));
        console.log(JSON.parse(sessionStorage.mcq));
        return myResponse;
      }
      fetch(mcq)
        .then((response) => response.json())
        .then((data) => {
          if (data.response_code === 1) {
            alert("No test available");
            location.href = "./index.html";
          }
          ques = convertApi(data).questions;
          totalQues = ques.length;
          sessionStorage.setItem("totalQues", totalQues);
          totalTime = totalQues * perQuesTime;
          // let tempArr = [];
          let maxOptions = 0;
          for (let i = 0; i < totalQues; i++) {
            maxOptions = Math.max(maxOptions, ques[i].answers.length);
          }
          // console.log(maxOptions);
          for (let i = 0; i < totalQues; i++) {
            result[i] = maxOptions;
            // tempArr[i] = maxOptions;
          }
          // sessionStorage.setItem("QuizName", tempArr);
          $(".quitSubmit").css("visibility", "visible");
          start(ques);
        });
      function onSubmit() {
        sessionStorage.setItem("resultShow", true);
        sessionStorage.setItem("TestStart", false);
        $(".quitSubmit").css("visibility", "hidden");

        let resultArr = [];
        for (let key in result) resultArr.push(result[key]);
        var correctAnswers = [];
        for (let i = 0; i < totalQues; i++) {
          correctAnswers.push(ques[i].correctIndex);
        }

        if (totalQues != quesNumber)
          sessionStorage.setItem(
            "YourScore",
            calculateResult(resultArr, correctAnswers)
          );
        clearInterval(intr);
        $("#quiz").hide();
        $(".alert").addClass("alert-primary");
        alertMessage("Calculating your result wait", 2800);
        setTimeout(() => {
          location.href = "./resultTest.html";
        }, 3000);
      }
      function onExit() {
        $(".quitSubmit").css("visibility", "hidden");

        let resultArr = [];
        sessionStorage.setItem("resultShow", false);
        sessionStorage.clear();
        for (let key in result) resultArr.push(result[key]);
        if (totalQues != quesNumber)
          sessionStorage.setItem("QuizName", resultArr);
        location.href = "./index.html";
      }
      function onExitClick() {
        confirm_dialog(
          "Exit Confirmation",
          "<p>Are you sure you want to exit?</p>",
          "onExit"
        );
      }
      function onSubmitClick() {
        confirm_dialog(
          "Submit Confirmation",
          "<p>Are you sure you want to submit?</p>",
          "onSubmit"
        );
      }
    </script>
  </body>
</html>
